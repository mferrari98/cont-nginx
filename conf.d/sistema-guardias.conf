# ------------------------------------------------------
# HTTP-level directives (included by nginx.conf)
# ------------------------------------------------------
server_tokens off;
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/m;
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_log_level warn;
limit_req_log_level warn;

client_body_timeout 10s;
client_header_timeout 10s;
send_timeout 10s;

real_ip_header X-Forwarded-For;
set_real_ip_from 10.10.0.0/16;
real_ip_recursive on;

log_format main_ext '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time ua="$upstream_addr" '
                    'us="$upstream_status" uct="$upstream_connect_time" '
                    'urt="$upstream_response_time" host="$host" '
                    'xff="$http_x_forwarded_for"';

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

map $uri $loggable {
    default 1;
    ~*\.css$ 0;
    ~*\.js$ 0;
    ~*\.png$ 0;
    ~*\.jpg$ 0;
    ~*\.jpeg$ 0;
    ~*\.gif$ 0;
    ~*\.ico$ 0;
    ~*\.svg$ 0;
    ~*\.woff$ 0;
    ~*\.woff2$ 0;
    ~*\.ttf$ 0;
    ~*\.eot$ 0;
    =/favicon.svg 0;
    =/health.html 0;
    =/guardias/health 0;
}

# Upstreams para los servicios
upstream portal_upstream {
    server portal-servicios:80 max_fails=3 fail_timeout=30s;
}

upstream sistema_guardias_upstream {
    server sistema-guardias:5000 max_fails=3 fail_timeout=30s;
}

upstream sistema_empa_upstream {
    server sistema-empa:80 max_fails=3 fail_timeout=30s;
}

upstream sistema_reportespiolis_upstream {
    server sistema-reportespiolis:3000 max_fails=3 fail_timeout=30s;
}

upstream sistema_reporte_upstream {
    server sistema-reportespiolis:3000 max_fails=3 fail_timeout=30s;
}

upstream sistema_monitor_recursos_upstream {
    server sistema-monitor-recursos:80 max_fails=3 fail_timeout=30s;
}

server {
    listen 80 default_server;
    server_name _;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2 default_server;
    server_name _;

    ssl_certificate /etc/nginx/ssl/selfsigned.crt;
    ssl_certificate_key /etc/nginx/ssl/selfsigned.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;
    ssl_session_tickets off;

    add_header Strict-Transport-Security "max-age=31536000" always;

    # Resolver para nombres de contenedores Docker
    resolver 127.0.0.11 valid=30s;

    access_log /dev/stdout main_ext if=$loggable;
    access_log /var/log/nginx/access.log main_ext if=$loggable;
    error_log /var/log/nginx/error.log warn;

    # Connection limiting (per client)
    limit_conn perip 20;
    limit_conn_status 429;
    limit_req_status 429;
    limit_req_log_level warn;

    # Default auth for all routes (bypass for internal network via $auth_basic).
    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/htpasswd; # mount or bake into image

    client_max_body_size 2m;
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com; connect-src 'self'; img-src 'self' data: blob:; font-src 'self' data:; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; form-action 'self'" always;

    # Excluir health checks de los logs
    location = /health.html {
        access_log off;
        auth_basic off;
        try_files $uri $uri/ @fallback;
    }

    # Excluir health checks del sistema de guardias
    location = /guardias/health {
        access_log off;
        auth_basic off;
        proxy_pass http://sistema_guardias_upstream/health;
        proxy_set_header Host $host;
        proxy_set_header X-Auth-User $remote_user;
        proxy_set_header X-Real-IP $remote_addr;

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;

    }

    # Normalizar rutas sin slash final
    location = /guardias {
        return 301 /guardias/;
    }

    location = /monitor {
        return 301 /monitor/;
    }

    location = /pedidos {
        return 301 /pedidos/;
    }

    # Redirect legacy /empa to /pedidos
    location = /empa {
        return 301 /pedidos/;
    }

    location /empa/ {
        rewrite ^/empa/(.*)$ /pedidos/$1 permanent;
    }

    # Proxy para /pedidos/
    location /pedidos/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_empa_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;
    }

    # Proxy para /reporte/ (alias para cont-reportespiolis)
    location = /reporte {
        return 301 /reporte/;
    }

    location /reporte/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_reporte_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /reporte;
        proxy_buffering off;
    }

    # Proxy para /monitor/api/
    location /monitor/api/ {
        limit_req zone=api burst=60 nodelay;
        proxy_pass http://sistema_monitor_recursos_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Auth-User $remote_user;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /monitor;
        proxy_buffering off;
    }

    # Proxy para /monitor/
    location /monitor/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_monitor_recursos_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /monitor;
        proxy_buffering off;
    }

    # Proxy para /guardias/ (excepto /static/)
    location /guardias/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_guardias_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
        proxy_buffering off;
    }

    location ~ ^/guardias/api/clima {
        access_log off;
        limit_req zone=api burst=60 nodelay;
        proxy_pass http://sistema_guardias_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
    }

    location /guardias/api/ {
        limit_req zone=api burst=60 nodelay;
        proxy_pass http://sistema_guardias_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
        proxy_buffering off;
    }

    # Portal de Servicios - aplicación principal en la raíz
    location = / {
        limit_req zone=auth burst=20 nodelay;
        proxy_pass http://portal_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;

        # Handle SPA routing - try files first, then proxy to index.html
        # This allows React Router to handle client-side routing
        try_files $uri $uri/ @fallback;
    }

    location / {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://portal_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;

        # Handle SPA routing - try files first, then proxy to index.html
        # This allows React Router to handle client-side routing
        try_files $uri $uri/ @fallback;
    }

    # Fallback for React SPA
    location @fallback {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://portal_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
    }

}
