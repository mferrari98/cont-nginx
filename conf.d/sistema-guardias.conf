# ------------------------------------------------------
# HTTP-level directives (included by nginx.conf)
# ------------------------------------------------------
server_tokens off;
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_log_level warn;
limit_req_log_level warn;

client_body_timeout 10s;
client_header_timeout 10s;
send_timeout 10s;

real_ip_header X-Forwarded-For;
set_real_ip_from 10.10.0.0/16;
real_ip_recursive on;

geo $is_internal {
    default 0;
    10.10.0.0/16 1;
}

map $is_internal $auth_basic {
    0 "Restricted";
    1 "off";
}

log_format main_ext '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time ua="$upstream_addr" '
                    'us="$upstream_status" uct="$upstream_connect_time" '
                    'urt="$upstream_response_time" host="$host" '
                    'xff="$http_x_forwarded_for"';

map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

# Upstreams para los servicios
upstream portal_upstream {
    server portal-servicios:80 max_fails=3 fail_timeout=30s;
}

upstream sistema_guardias_upstream {
    server sistema-guardias:5000 max_fails=3 fail_timeout=30s;
}

upstream sistema_empa_upstream {
    server sistema-empa:80 max_fails=3 fail_timeout=30s;
}

upstream sistema_reportespiolis_upstream {
    server sistema-reportespiolis:3000 max_fails=3 fail_timeout=30s;
}

upstream sistema_reporte_upstream {
    server sistema-reportespiolis:3000 max_fails=3 fail_timeout=30s;
}

upstream sistema_monitor_recursos_upstream {
    server sistema-monitor-recursos:80 max_fails=3 fail_timeout=30s;
}

server {
    listen 80;
    server_name _;

    # Resolver para nombres de contenedores Docker
    resolver 127.0.0.11 valid=30s;

    access_log /dev/stdout main_ext;
    error_log /dev/stderr warn;

    # Connection limiting (per client)
    limit_conn perip 20;
    limit_conn_status 429;
    limit_req_status 429;
    limit_req_log_level warn;

    # Default auth for all routes (bypass for internal network via $auth_basic).
    auth_basic $auth_basic;
    auth_basic_user_file /etc/nginx/.htpasswd; # mount or bake into image

    client_max_body_size 2m;
    proxy_connect_timeout 5s;
    proxy_read_timeout 30s;
    proxy_send_timeout 30s;
    proxy_hide_header X-Powered-By;
    proxy_hide_header Server;

    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # Excluir health checks de los logs
    location = /health.html {
        access_log off;
        auth_basic off;
        try_files $uri $uri/ @fallback;
    }

    # Excluir health checks del sistema de guardias
    location = /guardias/health {
        access_log off;
        auth_basic off;
        proxy_pass http://sistema_guardias_upstream/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
    }


    # Auth endpoints for portal
    location = /api/auth/login {
        limit_req zone=api burst=10 nodelay;
        default_type application/json;
        add_header Cache-Control "no-store";
        return 200 '{"username":"admin"}';
    }

    location = /api/auth/logout {
        limit_req zone=api burst=10 nodelay;
        default_type application/json;
        add_header Cache-Control "no-store";
        return 200 '{"success":true}';
    }

    location ~ ^/(?:\.git|\.env|\.htpasswd) {
        return 404;
    }

    # Servir archivos estáticos de /guardias/static/
    location /static/ {
        limit_req zone=general burst=20 nodelay;
        alias /usr/share/nginx/html/sistema-guardias-static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Proxy para /reporte/ (alias para cont-reportespiolis)
    location /reporte/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_reporte_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;
    }

    # Proxy para /reportespiolis/
    location /reportespiolis/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_reportespiolis_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;
    }

    # Proxy para /empa/
    location /empa/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_empa_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;
    }

    # Proxy para /monitor/api/
    location /monitor/api/ {
        limit_req zone=api burst=60 nodelay;
        proxy_pass http://sistema_monitor_recursos_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /monitor;
        proxy_buffering off;
    }

    # Proxy para /monitor/
    location /monitor/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_monitor_recursos_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /monitor;
        proxy_buffering off;
    }

    # Proxy para /guardias/ (excepto /static/)
    location /guardias/ {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://sistema_guardias_upstream/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
        proxy_buffering off;
    }

    # Excluir endpoints de API del sistema de guardias (logs reducidos)
    location ~ ^/guardias/api/cache {
        access_log off;
        auth_basic off;
        allow 10.10.0.0/16;
        deny all;
        limit_req zone=api burst=60 nodelay;
        proxy_pass http://sistema_guardias_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
    }

    location ~ ^/guardias/api/clima {
        access_log off;
        limit_req zone=api burst=60 nodelay;
        proxy_pass http://sistema_guardias_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
    }

    # Portal de Servicios - aplicación principal en la raíz
    location / {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://portal_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_buffering off;

        # Handle SPA routing - try files first, then proxy to index.html
        # This allows React Router to handle client-side routing
        try_files $uri $uri/ @fallback;
    }

    # Fallback for React SPA
    location @fallback {
        limit_req zone=general burst=20 nodelay;
        proxy_pass http://portal_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Prefix /guardias;
        proxy_set_header X-Script-Name /guardias;
    }

}