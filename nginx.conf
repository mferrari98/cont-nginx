# ==========================================================
#  CONFIGURACIÓN NGINX PARA RED LOCAL - VERSIÓN DOCKER
# ==========================================================

# NOTA: Esta configuración se incluirá dentro del bloque http de nginx
# Las directivas como limit_req_zone deben estar aquí

# ------------------------------------------------------
#  Rate Limiting (proteccion contra abusos)
# ------------------------------------------------------
server_tokens off;
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api:10m rate=30r/s;
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_log_level warn;

# ------------------------------------------------------
#  Real IP (proxy trusted network)
# ------------------------------------------------------
real_ip_header X-Forwarded-For;
set_real_ip_from 10.10.0.0/16;
real_ip_recursive on;

# ------------------------------------------------------
#  Log format for fail2ban
# ------------------------------------------------------
log_format main_ext '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent" '
                    'rt=$request_time ua="$upstream_addr" '
                    'us="$upstream_status" uct="$upstream_connect_time" '
                    'urt="$upstream_response_time" host="$host" '
                    'xff="$http_x_forwarded_for"';

# ------------------------------------------------------
#  UPGRADE WEBSOCKETS
# ------------------------------------------------------
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}
